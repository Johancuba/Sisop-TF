<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <title>Productos - Adminia CMS</title>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)) !important; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .navbar-brand { font-weight: bold; font-size: 1.5rem; color: white !important; }
        .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; }
        .nav-link:hover, .nav-link.active { color: white !important; background: rgba(255,255,255,0.2); border-radius: 5px; }
        .container-main { padding: 30px 15px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-weight: 600; border-radius: 12px 12px 0 0 !important; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; }
        .table thead { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .modal-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="bi bi-grid-3x3-gap-fill"></i> Adminia</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin/categorias"><i class="bi bi-tags"></i> Categorías</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/admin/productos"><i class="bi bi-box-seam"></i> Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin/usuarios"><i class="bi bi-people"></i> Usuarios</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/swagger" target="_blank"><i class="bi bi-book"></i> API Docs</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-main">
        <div class="container">
            <div class="card">
                <div class="card-header"><h4 class="mb-0"><i class="bi bi-box-seam"></i> Gestión de Productos (NoSQL)</h4></div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary"><i class="bi bi-plus-circle"></i> Nuevo Producto</h5>
                            <form id="formCrear" class="row g-3">
                                <div class="col-md-6"><label class="form-label">Título *</label><input type="text" class="form-control" id="titulo" required></div>
                                <div class="col-md-3"><label class="form-label">Precio *</label><input type="number" step="0.01" class="form-control" id="precio" required></div>
                                <div class="col-md-3"><label class="form-label">Stock *</label><input type="number" class="form-control" id="stock" required></div>
                                <div class="col-md-6"><label class="form-label">SKU *</label><input type="text" class="form-control" id="sku" required></div>
                                <div class="col-md-6"><label class="form-label">Categoría *</label><select class="form-select" id="categoria" required><option value="">Seleccione...</option></select></div>
                                <div class="col-12"><label class="form-label">Descripción</label><textarea class="form-control" id="descripcion" rows="2"></textarea></div>
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-images"></i> Imágenes (URLs)</label>
                                    <input type="text" class="form-control mb-2" id="imagen1" placeholder="https://ejemplo.com/img1.jpg">
                                    <input type="text" class="form-control mb-2" id="imagen2" placeholder="https://ejemplo.com/img2.jpg">
                                    <small class="text-muted">Array embebido en documento</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-tags"></i> Metadatos</label>
                                    <input type="text" class="form-control mb-2" id="marca" placeholder="Marca">
                                    <input type="text" class="form-control mb-2" id="modelo" placeholder="Modelo">
                                    <small class="text-muted">Objeto embebido en documento</small>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save"></i> Crear Producto</button>
                                    <button type="reset" class="btn btn-secondary btn-lg"><i class="bi bi-x-circle"></i> Limpiar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <hr>
                    <h5 class="text-primary mb-3"><i class="bi bi-list-ul"></i> Listado de Productos</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr><th>SKU</th><th>Producto</th><th>Categoría</th><th>Precio</th><th>Stock</th><th>Imágenes</th><th>Acciones</th></tr>
                            </thead>
                            <tbody id="tablaProductos">
                                <tr><td colspan="7" class="text-center"><div class="spinner-border text-primary"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title"><i class="bi bi-info-circle"></i> Detalles del Producto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="detalleProducto"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let productos = [], categorias = [];
    let modalDetalle;

    document.addEventListener('DOMContentLoaded', () => {
        console.log('Cargando productos y categorías...');
        modalDetalle = new bootstrap.Modal(document.getElementById('modalDetalle'));
        cargarCategorias();
        cargarProductos();
    });

    async function cargarCategorias() {
        try {
            const response = await fetch('/api/categorias');
            const result = await response.json();
            console.log('Categorías:', result);
            if (result.success) {
                categorias = result.data.filter(c => c.activo);
                const select = document.getElementById('categoria');
                select.innerHTML = '<option value="">Seleccione...</option>' + categorias.map(cat => `<option value="${cat._id}">${cat.nombre}</option>`).join('');
            }
        } catch (error) { console.error('Error categorías:', error); }
    }

    document.getElementById('formCrear').addEventListener('submit', async (e) => {
        e.preventDefault();
        const imagenes = [document.getElementById('imagen1').value, document.getElementById('imagen2').value].filter(i => i.trim());
        const metadatos = { marca: document.getElementById('marca').value || null, modelo: document.getElementById('modelo').value || null };
        const data = {
            titulo: document.getElementById('titulo').value,
            descripcion: document.getElementById('descripcion').value,
            precio: parseFloat(document.getElementById('precio').value),
            stock: parseInt(document.getElementById('stock').value),
            sku: document.getElementById('sku').value,
            categoria: document.getElementById('categoria').value,
            imagenes, metadatos
        };
        console.log('Creando producto:', data);
        try {
            const response = await fetch('/api/productos/crear', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const result = await response.json();
            console.log('Respuesta:', result);
            if (result.success) { alert('✅ Producto creado'); e.target.reset(); cargarProductos(); }
            else alert('❌ Error: ' + result.message);
        } catch (error) { console.error(error); alert('❌ Error al crear'); }
    });

    async function cargarProductos() {
        try {
            console.log('Fetch /api/productos...');
            const response = await fetch('/api/productos');
            const result = await response.json();
            console.log('Productos:', result);
            if (result.success) { productos = result.data; renderProductos(); }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('tablaProductos').innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }

    function renderProductos() {
        const tbody = document.getElementById('tablaProductos');
        console.log('Renderizando', productos.length, 'productos');
        if (productos.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-inbox"></i> No hay productos. Crea el primero arriba.</td></tr>`;
            return;
        }
        tbody.innerHTML = productos.map(p => `
            <tr>
                <td><code>${p.sku}</code></td>
                <td><strong>${p.titulo}</strong><br><small class="text-muted">${p.descripcion || ''}</small></td>
                <td><span class="badge bg-info">${p.categoria?.nombre || 'N/A'}</span></td>
                <td><strong>$${p.precio.toFixed(2)}</strong></td>
                <td><span class="badge ${p.stock > 0 ? 'bg-success' : 'bg-danger'}">${p.stock}</span></td>
                <td><span class="badge bg-secondary">${p.imagenes?.length || 0} imgs</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="verDetalle('${p._id}')"><i class="bi bi-eye"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarProducto('${p._id}', '${p.titulo}')"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    function verDetalle(id) {
        const p = productos.find(prod => prod._id === id);
        if (!p) return;
        const imgs = p.imagenes?.map(i => `<img src="${i}" class="img-thumbnail me-2" style="width:100px;height:100px;object-fit:cover;" onerror="this.src='https://via.placeholder.com/100'">`).join('') || '<span class="text-muted">Sin imágenes</span>';
        const meta = p.metadatos ? `<ul><li><strong>Marca:</strong> ${p.metadatos.marca || 'N/A'}</li><li><strong>Modelo:</strong> ${p.metadatos.modelo || 'N/A'}</li></ul>` : '<span class="text-muted">Sin metadatos</span>';
        document.getElementById('detalleProducto').innerHTML = `
            <div class="row">
                <div class="col-md-6"><h6 class="text-primary">Información</h6><p><strong>Título:</strong> ${p.titulo}</p><p><strong>SKU:</strong> ${p.sku}</p><p><strong>Precio:</strong> $${p.precio.toFixed(2)}</p><p><strong>Stock:</strong> ${p.stock}</p></div>
                <div class="col-md-6"><h6 class="text-primary">Imágenes Embebidas</h6><div class="mb-3">${imgs}</div><h6 class="text-primary">Metadatos Embebidos</h6>${meta}</div>
            </div>
        `;
        modalDetalle.show();
    }

    async function eliminarProducto(id, titulo) {
        if (!confirm(`¿Eliminar "${titulo}"?`)) return;
        try {
            const response = await fetch(`/api/productos/borrar/${id}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) { alert('✅ Eliminado'); cargarProductos(); }
            else alert('❌ Error: ' + result.message);
        } catch (error) { alert('❌ Error'); console.error(error); }
    }
    </script>
</body>
</html>
